---
title: "流水线架构"
keywords: sample homepage
tags: [getting_started]
sidebar: rtr
layout: book
permalink: rtr_ch2_architecture.html
summary: 渲染流水线。
---


 > <font color="gray">"决定链条强度的是它最弱的部分"        -- 佚名</font>



这章我们要开始接触实时渲染的核心部分：图像渲染流水线(译注：这里说流水线比较容易理解)，有时候也就叫流水线。流水线是干嘛的呢，给定一个摄像机，一些三维对象、光源，指定渲染方式，纹理以及其他东西，然后得到一个二维图像。2.1节介绍具体的处理过程。最终图像上的绘制对象的形状和位置是怎么得到呢？对象的几何属性，环境特征以及相机的位置都会有影响。对象的表现则受材质属性、光源、纹理、渲染模式的影响。

我们会讨论渲染流水线的各个阶段的功能，他们的具体实现就不讨论了。后面也不会讨论这些实现细节，因为开发者也没法控制他们。举例栗子，开发者绘制线的时候关心的是顶点数据格式、颜色、模式等等，而不会关心线条是使用 Bresenham的画线算法实现的，或其他什么双步对称算法。通常这些阶段实现在不可操作的硬件部分，所以也没法优化或改进他们的实现。《Rogers[1077]》中深入探讨了基础绘制和填充算法。虽然我们可能可以稍稍控制一下底层硬件，但是算法和实现函数对生成图像的速度和质量意义更加重大。

![图1](/images/figure2_1.png)

图2.1 在左图，虚拟相机在上面线条交汇的地方。只有在可视范围的图元会被绘制，最终投影绘制成图片。可视范围就是平截头体。右图就是相机看到的图像。注意红色的圈在可视范围外面，所以没有被绘制。


### 2.1 架构
在现实世界，流水线有各种不同的形式，从工厂生产线到滑雪吊椅运作等等。它也表示图形渲染。

流水线一般都分为多个阶段。比如说，一个石油流水线，在第一段管道里的石油，必须要等第二段管道里的石油流到第三段管道之后，才能流进第二管道等等。整个管道的速度受限于最慢的部分。

理想情况下，一个非流水线系统，改进成有n个阶段的流水线系统后，速度提升会是n成正比。这是使用流水线的主要原因。举例个例子，一个滑雪缆车一次只运一个车上山非常的低效，增加n个座椅就能提高n倍速度。流水线各阶段能够并行的运行，但最终要等最慢的部分完成。假设汽车方向盘组装需要三分钟，其他各部分组装都只需要两分钟，那么其他部分组装完成了也得等上一分钟，一辆车才能组装完成。这里方向盘组装就是整个系统的瓶颈，它决定了整个产品的速度。

这种流水线在实时计算机图形(以下简称CG)中很常见。我们可以简单粗暴的把实时CG流水线分为三个概念上的阶段：应用阶段、几何阶段、栅格阶段，2.2节会详细介绍。这个结构是渲染流水线引擎的核心概念，也是后面各个章节基础中的基础，应用于各种实时渲染软件。每个阶段也有他们自己的流水线，就是说可能会多个子阶段。有几种不同的分类方式：概念阶段(包括应用、几何、栅格阶段)，功能阶段和流水线阶段。一个功能阶段是指完成一个特定的功能，但不限制如何去完成这个功能。一个流水线阶段，一方面它与其他流水线阶段同步运行。它有时也会按顺序平行放置来达到更高级的表现需求。举例来说，几何阶段可能会被分为5个功能阶段，但是图像系统的实现会自己决定分为几个流水线阶段。比方某个实现把两个功能阶段合并成一个流水线阶段，而对其他功能阶段却可能划分成多个流水阶段，或者一对一的划分。

![图1](/images/figure2_1.png)

最慢的流水线阶段决定了绘制、更新图像速度。这个速度可以用fps来表示，就是每秒更新多少次图像。它也能用频率Hz来表示，Hz就是1/s的意思。在软件中每次渲染图像的时间是变换的，因为还取决于每帧要计算多少东西。fps不仅可以表示单帧的速度，还能表示一段时间的速度。而Hz仪表用于硬件，比方显示器，一般来说都是一个固定的速率。我们要处理的是一个流水线，它的时间并不满足把各个东西绘制时间累加的结果。当然了，因为流水线的架构带来的结果，很多部分都是并行运行的。如果我们能定位瓶颈，也就是最慢的阶段，并测出它要花费多长时间，那我们也就能够算出整个渲染速度。假设瓶颈部分要花费20ms，那么整个渲染速度就是1000/20=50Hz。不过这个只有在最终显示器能够<font color="tomato">恰好支持这个频率</font>的时候成立，否则真是速率会被迫降低。在其他流水线领域，这个就叫做产能。

例子：渲染速度。假设我们的输出设备最大刷新平率是60Hz，并且我们已经找到渲染的瓶颈阶段。这个瓶颈阶段需要耗时62.5ms。那么渲染速度计算如下。首先忽略输出设备，我们得到最大渲染速度为 1000/62.5 = 16fps。然后根据输出设备来矫正这个值。我们的输出设备是60Hz，那么它能支持的渲染速度就是 60/2 = 30Hz, 60/3 = 20Hz, 60/4 = 15Hz, 60/5 = 12Hz,等等。所以我们的渲染速度只能是15Hz，因为低于16fps，输出设备最大只能支持到这个值了(很显然不能超过16fps的)。

正如名称显示的那样，应用阶段由应用程序控制，在软件的运行的过程中，在通用CPU中完成。这些CPU通常也包含多核，能够并行执行多线程。CPU能够高效的完成各种功能，这也是应用阶段的职责。很多功能一般都是在cpu上完成，比如碰撞检测、全局加速算法、动画、物理模拟、以及很多其他方面，这主要也取决于应用的类型。下一个阶段就是几何阶段，主要处理变换、投影等等。这个阶段关注画些啥，怎么画，在哪画的问题。这是一个典型的运行在GPU上的阶段。GPU是一个拥有很多可编程核心和固定功能核心的硬件。最后，栅格阶段把上个阶段产生的数据绘制成图片，以及完成逐像素计算的需求。栅格阶段完全在GPU上运行。接下来三小节会深入讨论这三个阶段。第三章会探索GPU如何处理这些阶段。







