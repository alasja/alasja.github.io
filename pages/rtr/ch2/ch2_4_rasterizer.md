---
title: "栅格阶段"
keywords: sample homepage
tags: [getting_started]
sidebar: rtr
layout: book
permalink: rtr_ch2_rasterizer.html
summary: 栅格阶段。
---



### 2.4 栅格阶段
栅格阶段的目标是使用变换投影过的顶点及关联的着色数据（几何阶段），来计算物体覆盖的像素的颜色值。这个过程叫做栅格化或者扫描装换，这个变换就是从二维的屏幕空间 —— 每个顶点数据还包括z数据（深度值），以及相关的着色信息 —— 变换到屏幕像素点。

跟几何阶段一样，栅格阶段也被划分成几个功能阶段：三角形装配，三角形遍历，像素着色，合并。见图2.8。

![图2-8](/images/RTR3.02.08.png)

### 2.4.1 三角形装配
这个阶段会计算三角面各异的数据。这些数据用于扫描装换，也会对几何阶段产生的各种着色数据进行插值。这个阶段在专门为该功能设计的固定功能硬件上执行。

### 2.4.2 三角形遍历
这里要检测每个像素的中心点(或者采样)是否被三角形覆盖到，像素跟三角形区域重合的部分会生成一个<font color="tomato">片元</font>。三角形遍历或者扫描变换就是指找到这些在三角形内的像素或采样。每个三角形片元的属性，由三个顶点的属性插值产生（详见第五章）。这些属性包括深度和几何阶段产生的各种着色数据。Akeley以及Jermoluk[7]，Rogers[1077]的论文中可以查看更多详尽的信息。

### 2.4.3 像素着色
所有的逐像素着色计算都是在这里完成，计算的输入数据是经过插值的着色数据。一个或多个颜色最终被传递到下个阶段。与三角形装配和三角形遍历运行在固定电路上不同的是，这个阶段在可编程的GPU单元上运行。在这里可以完成各种各样的技术，其中最重要的的纹理贴图。到第六章才会详细讲解纹理。简单来说，纹理就是把一个图片粘在一个物体上。图2.9描述了这个过程。图片是一个或者多个，三维的，当然二维的图片比较常用。

![图2-9](/images/RTR3.02.09.png)

### 2.4.4 合并
每个像素的数据存储在颜色缓冲里，颜色缓冲其实就是一个矩形的颜色列表（颜色包括红绿蓝部分）。合并阶段其实就是合并片元着色产生的颜色跟颜色缓冲里的颜色。这个阶段各像素着色也不太一样，它不能完全可编程。但是它配置多啊，能够完成各种效果。

这个阶段还有个任务是处理可见性。这表示，整个场景渲染完成后，颜色缓冲里存储着所有能被当前相机照到的图元的颜色。大部分图形硬件都是使用Z缓冲算法来完成这个功能。Z缓冲跟颜色缓冲大小一样，形状也一样，不过它的每个点存储的是当前里相机最近的图元的Z值（就是深度值）。当一个图元要写入一个像素的时候，图元在这个像素上的Z值会被计算出来，然后跟Z缓冲中改点存储的Z值比较。如果新的Z值比较小，说明在这个像素点上，当前绘制的这个图元比之前绘制的图元离相机近。然后呢，这点的Z缓冲和颜色缓冲就都更新成最新的Z值和颜色值。如果新的Z值比较大的话，就保留原有的数据不动。

Z缓冲算法非常简单，效率是$O(n)$，其中n是图元覆盖的像素数量。Z缓冲对每个绘制的图元都作用一遍，当然前提是图元相关的像素的深度能被计算出来。这个算法这么受欢迎的另一原因是，它允许图元使用任意顺序来渲染。不过，话说回来，半透明的图元的渲染顺序就不能随便了。他们必须要在所有不透明的图片绘制完了之后绘制，并且要按从远到近的顺序来绘制（详见5.7节）。这可能是Z缓冲最大的弱点了。

我们前面提到颜色缓冲记录各像素颜色，Z缓冲记录各像素的z值。实际上，还有个颜色通道和缓冲来记录片元信息。那就是alpha透明通道，它在颜色缓冲中记录每个像素的透明度（详见5.7节）。透明测试是可选的，它可以在片元的深度测试之前进行。片元的alpha值会跟指定的值做一些比较（相等、更大等等）。如果片元没有通过透明测试，他就被剔除了，不用处理后面的流程。这个测试要注意的是，全透明的的图元不能写入Z缓冲（详见6.6节）

模板缓冲是记录图元绘制位置的幕后缓冲。它一般情况下每个像素只有8位的数据。可以使用一些函数把图元绘制到模板缓冲，然后这个缓冲就可以用来控制颜色缓冲和Z缓冲的写入。举例来说，假如一个填充的圆绘制到模板缓冲了。那么结合一些操作，就可以控制后面的图元只绘制在这个圆形范围内的部分。模板测试对构造特殊效果非常有用。这些函数被称为栅格操作（ROP）或则混合操作。

帧缓冲一般表示所有的缓冲，不过有时候它只表示颜色缓冲和Z缓冲的集合。1990年，Haeberli和Akeley[474]的文献中提出了一中新的帧缓冲部分，叫做累计缓冲(accumulation buffer)。这个缓冲可以把图像累计起来做一些操作。比方说，运动物体的多个图像，就可以进行累计平均来构造运动模糊。其他效果还有场景深度、抗锯齿及软阴影等。

----------
经过栅格阶段之后，能被相机观察到的图元就被显示到屏幕上了。屏幕就是显示颜色缓冲中的内容。为避免人们看到图元的绘制过程，这里会使用双缓冲技术。当场景在后缓冲中绘制完成后，后缓冲和当前显示的前缓冲内容就会交换。这个过程发生在垂直重绘期间，是很安全的。

5.6.2节和18.1节会介绍更多缓冲及缓冲算法的内容。
