---
title: "顶点混合"
sidebar: rtr
layout: book
permalink: rtr_ch4_vertex.html
summary: 第四章.
---

### 4.4 顶点混合
想象一个数字角色的胳膊可以使用两个部分来做动画，上臂和前臂，如图4.10中左边显示。

![图](/images/RTR3.04.10.png)

(<font color="DarkGoldenRod">图4.10. 左图中，一个胳膊使用一个前臂和上臂来变换刚体动画。关节显的不真实。右图中，对单个对象使用了顶点混合。右二图展示了简单的关节变换。最右展示了顶点混合的使用，不同的顶点使用不同的权重来融合。（2/3, 1/3)表示该点的变换，上臂的变换占2/3，前臂占1/3。最右图还展示了顶点融合的缺点。这里，内部可折叠部分也会被看到。更多的骨骼和更精心挑选的权重可以达到更好的效果。</font>)

这个模型可以使用刚体变换来完成动画(见4.16节)。不过这样两个部分的连接跟真实的肘关节就很不像了。这是因为使用了两个不同的对象，而且关节由两个独立部分的重复部分构成。很明显，只使用单个对象会更好。不管怎样，模型的静态部分不需要关心如何让关节灵活变换的问题。

`顶点混合`是解决关节问题的一个可行方案。这个技术还有一些其他名字，比如`蒙皮(skinning)，包络(enveloping),和骨骼空间变形(skeleton-subspace deformation)`。这个算法的来源已经不清楚了，但在计算机动画领域，骨骼以及蒙皮的变换已经是广为人知的概念了。在它的简单形式中，前臂和上臂跟之前一样独立动画，不过在连接点，两个部分使用一个弹性的皮肤来连接。所以，这个弹性部分的一部分顶点可以使用前臂的矩阵来变换，另一部分则可以用上臂的矩阵来变换。与每个三角形都用单个矩阵来变换相比，这个结果会导致某些三角形的顶点使用不同的矩阵来变换，见图4.10.这个基础技术有时也叫`stitching`

我们在深入探讨一点，这个技术可以允许单个顶点被多个不同的矩阵作用，使用不同权重来混合结果位置。这需要动画对象的骨骼来完成，每个骨骼都可能会按自定义的权重来影响每个顶点。真个胳膊都可以像橡皮一样，就是所有的顶点都可以被多个矩阵作用，整个网格通常被称为`皮肤(skin)`（骨骼之上）。见图4.11。很多商业建模软件都有这些类似的骨骼建模特性。尽管他们的名字可能并不包含骨骼。举个例子，Mohr 和 Gleicher在他们的文章中展示了一种使用额外节点来表现凸起肌肉效果的想法。James 和 Twigg在他们的文章中讨论了一种可以压缩和拉伸，使用骨骼的动画皮肤。

![图](/images/RTR3.04.11.png)
图4.11 一个真实的顶点融合示例。

在数学上，我们可以等式4.56来表示顶点混合，其中p是原始顶点，`u(t)`则是跟时间t相关，变换后的顶点。n表示同时作用在顶点p上骨骼数量，这是在世界空间下的表示。矩阵$M_i$是初始骨骼的坐标空间，变换到世界坐标空间的矩阵。通常一个骨骼的控制关节都在它的坐标原点。举个例子，前臂的骨骼可以把肘关节移动到原点，然后可以使用动画的旋转矩阵来绕着关节移动。矩阵$B_i(t)$是第i个骨骼随时间变换的世界变换，用于对象的动画操作，一般是多个矩阵的串联结果，比如父节点骨骼变换和局部动画矩阵的串联。Woodland[1376]在他的书中深入探讨了一种维护和更新矩阵$B_i(t)$的方法。最后，$w_i$是第i个骨骼对顶点p的权重。顶点混合等式如下：

$$
u(t) = \sum_{i=0}^{n-1} w_iB_i(t)M_i^{-1}p,\; where \; \sum_{i=0}^{n-1} w_i = 1, \quad w_i \ge 0. \tag{4.56}
$$

每个骨骼把一个顶点变换的一个位置，该位置受它本身的结构约束，最终的位置从多个点插值计算来得到。矩阵$M_i$在某些蒙皮讨论中直接提及，但它常被认为是$B_i(t)$的一部分。我们把它放在这，因为它很有用，基本总是会要在矩阵串联处理中用的。

实践中，矩阵$B_i(t)和M_i^{-1}$会在每一帧、每个骨骼上做串联，每个`结果矩阵`又会被作用到顶点上。顶点p会被不同骨骼的`结果矩阵`变换，然后使用权重$w_i$来做混合，这就是`顶点混合`这个名字的由来。权重不可以是负数，并且它们的和为1，所以某个顶点会被变换到一些位置上，然后使用这些位置来插值。因此，变换后的u的位置会在$B_i(t)M_i^{-1}p, i = 0...n-1,(t固定)$集合所构成凸面上。法线通常也可以使用等式4.56来变换。取决于使用的变换（比如某个骨骼被严重拉伸或挤压），$B_i(t)M_i^{-1}$逆的转置可能需要被计算，详见4.1.7。

顶点混合非常适合在GPU上处理。网格的顶点可以放在一个静态buffer中，然后一次性传递给GPU，再重复使用。每一帧中，只有骨骼的矩阵在变化，只需要一个顶点着色器计算他们作用在网格上的效果。通过这种方式，CPU的数据计算和传递都是最小化的，让GPU可以高效的渲染网格。如果模型的所有骨骼矩阵可以用在一块就更简单了，不过这样模型必须分割成多块，有些骨骼也会重复。

当使用顶点融合的时候，权重的数值可能被设置的超出[0,1]范围，权重的和也可能不是1。不过，这种设置有时候也是有意义的，比方使用`morph targets`混合算法的时候（见4.5）。

顶点融合的缺点之一是不必要的折叠和缠绕，还可能发生自相交。见图4.12。最好的解决方案是Kavan 等人提到的`双重四元素(dual quaternions)`方法。这种技术可以保留蒙皮的原始矩阵刚体特性，就避免了胳膊上糖纸般的扭曲。它的计算量低于线性混合计算量的1.5倍，不过效果非常棒，所以它被大家快速的采用。感兴趣的读者可以查阅相关论文，其中还包括了早前对线性混合改进的简短概览。

![图](/images/RTR3.04.12.png)
图4.12。左图使用线性插值，右图使用双四元数插值。


