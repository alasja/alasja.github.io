---
title: "流水线的一切"
keywords: sample homepage
tags: [getting_started]
sidebar: rtr
layout: book
permalink: rtr_ch2_pipeline.html
summary: 渲染管线。
---



### 2.5 流水线过程
点线三角形是最终的绘制图元，模型对象也是建立在此之上。想象一个计算辅助设计（CAD）程序，用户在测试一个手机的设计。我们来看看这个模型如何经过整个流水线，包括如下三个主要阶段：应用阶段，几何阶段和栅格阶段。场景被透视渲染到屏幕上的一个窗口中。在这个例子中，手机模型包括线条（原件的边缘）以及三角面（各种外表面）。部分三角面会使用2D贴图来显示屏幕上的键盘。着色计算完全在几何阶段就完成了，除了这个程序中的贴图是发生在栅格阶段的。

### 应用阶段
CAD程序可以让用户选择和移动模型的部件。比如，用户可以选中手机的顶部盖子并挪动来把手机打开。应用阶段需要把用户的鼠标操作转化成相应的旋转矩阵，然后当它渲染的时候，这个矩阵需要应用到对应的盖子上。另一个例子是相机按一个预定义的路径移动来展示手机的各个视角。应用程序需要根据时间来更新相机的位置和朝向参数。每一帧中，应用阶段需要把相机的位置、光照，以及模型的图元都传递给流水线的下个阶段 —— 几何阶段

### 几何阶段
视角的变化在应用阶段就计算好了，每个对象也会有他自己的模型矩阵来定义位置和方向。对每个传递给几何阶段的对象来说，这两个矩阵都会乘到一起变成一个。在整个阶段中，对象的点和法线都会使用这个矩阵来变换，让对象变换到可视空间。然后使用材质和光源属性进行点着色计算。接着就是投影了，对象被变换到标准视体中，这就是眼睛能到到的部分了。在视体外的图元都被丢弃了。与视体相交的图元会被裁剪，这样剩下的图元都是在视体内部了。再然后顶点就被映射到屏幕上的窗口中了。经过这些几何处理，结果数据被传递给流水线的最终阶段，栅格阶段


### 栅格阶段
在这个阶段，所有的图元都被栅格化，也就是转化成窗口上的像素点。在屏幕空间中，对象上所有可见的线条和三角形都会进入栅格阶段被转换。三角形如果关联了贴图的，就会绘制上指定的贴图。图元是否可见会使用Z缓冲算法，以及可选的透明测试和模板测试。依次处理完所有的对象，最终图像就被显示在屏幕上了。

### 结论
整个流水线为什么变成这样，是数十年来，API和图像硬件的在实时渲染应用上发展的结果。需要明白的是，这不是唯一可行的流水线，离线渲染流水线就经历的不同的发展路线。在电影上的渲染通常是使用微多边形(micropolygon)流水线[196,1326]。学术研究和预渲染应用中，比如建筑上的效果图一般都使用光线追踪渲染。

多年来，开发者们都只能用固定流水线来渲染。固定流水线这么叫是因为它的实现硬件是不可编程的。它的不同阶段可以设置不同的状态。比如Z缓冲可以打开或关闭，但是没法控制不同的阶段使用不同的函数。最新（可能也是最终的）的固定流水线硬件例子是任天堂的Wii。可编程的GPU让整个流水线各个阶段具体如何操作变成可修改的。固定流水线也能学到一些基础原理，不过现在基本都是在可编程管线上开发了。如非特殊说明，本书说的都是可编程流水线，这也是发挥GPU全部效能的最好方法。


### 扩展阅读和资源
Blinn的书《A Trip Down the Graphics Pipeline》,是一本关于如何写一个勉强能用的软渲染的书。不过它是学习渲染管线中一些精妙实现的好材料。对于固定流水线，经典的《OpenGL Programming Guide》（人称红宝书）中讲述了固定流水线和它使用的一些算法。[本书的网站上](http://realtimerendering.com)，提供了不少渲染引起的实现。

